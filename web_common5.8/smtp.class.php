<?php class smtp{ public $_D4;public $_D5;public $_D6;public $_D7;public $_D8;public $_D9;public $_DA;public $_DB;public $_DC;var $_DD;function smtp($_D8="",$_D4=25,$_DA=false,$_DB,$_DC){ $this->debug=FALSE;$this->smtp_port=$_D4;$this->relay_host=$_D8;$this->time_out=30;$this->auth=$_DA;$this->user=$_DB;$this->pass=$_DC;$this->host_name="localhost";$this->log_file="";$this->sock=FALSE;} function sendmail($_DE,$_DF,$_E0="",$_E1="",$_E2,$_E3="",$_E4="",$_E5=""){ $_E6=$this->get_address($this->strip_comment($_DF));$_E1=ereg_replace("(^|(\r\n))(\.)","\1.\3",$_E1);$_E7.="MIME-Version:1.0\r\n";if($_E2=="HTML"){ $_E7.="Content-Type:text/html\r\n";} $_E7.="To:".$_DE."\r\n";if ($_E3 !="") { $_E7.="Cc:".$_E3."\r\n";} $_E7.="From:$_DF<".$_DF.">\r\n";$_E7.="Subject:".$_E0."\r\n";$_E7.=$_E5;$_E7.="Date:".date("r")."\r\n";$_E7.="X-Mailer:By Redhat (PHP/".phpversion().")\r\n";list($_E8,$_E9)=explode(" ",microtime());$_E7.="Message-ID:<".date("YmdHis",$_E9).".".($_E8*1000000).".".$_E6.">\r\n";$_EA=explode(",",$this->strip_comment($_DE));if ($_E3 !="") { $_EA=array_merge($_EA,explode(",",$this->strip_comment($_E3)));} if ($_E4 !="") { $_EA=array_merge($_EA,explode(",",$this->strip_comment($_E4)));} $_EB=TRUE;foreach ($_EA as $_EC) { $_EC=$this->get_address($_EC);if (!$this->smtp_sockopen($_EC)) { $this->log_write("Error:Cannot send email to ".$_EC."\n");$_EB=FALSE;continue;} if ($this->smtp_send($this->host_name,$_E6,$_EC,$_E7,$_E1)) { $this->log_write("E-mail has been sent to <".$_EC.">\n");} else { $this->log_write("Error:Cannot send email to <".$_EC.">\n");$_EB=FALSE;} fclose($this->sock);$this->log_write("Disconnected from remote host\n");} return $_EB;} function smtp_send($_ED,$_DF,$_DE,$_E7,$_E1=""){ if (!$this->smtp_putcmd("HELO",$_ED)) { return $this->smtp_error("sending HELO command");} if($this->auth){ if (!$this->smtp_putcmd("AUTH LOGIN",base64_encode($this->user))) { return $this->smtp_error("sending HELO command");} if (!$this->smtp_putcmd("",base64_encode($this->pass))) { return $this->smtp_error("sending HELO command");} } if (!$this->smtp_putcmd("MAIL","FROM:<".$_DF.">")) { return $this->smtp_error("sending MAIL FROM command");} if (!$this->smtp_putcmd("RCPT","TO:<".$_DE.">")) { return $this->smtp_error("sending RCPT TO command");} if (!$this->smtp_putcmd("DATA")) { return $this->smtp_error("sending DATA command");} if (!$this->smtp_message($_E7,$_E1)) { return $this->smtp_error("sending message");} if (!$this->smtp_eom()) { return $this->smtp_error("sending <CR><LF>.<CR><LF> [EOM]");} if (!$this->smtp_putcmd("QUIT")) { return $this->smtp_error("sending QUIT command");} return TRUE;} function smtp_sockopen($_EE){ if ($this->relay_host=="") { return $this->smtp_sockopen_mx($_EE);} else { return $this->smtp_sockopen_relay();} } function smtp_sockopen_relay(){ $this->log_write("Trying to ".$this->relay_host.":".$this->smtp_port."\n");$this->sock=@fsockopen($this->relay_host,$this->smtp_port,$_EF,$_F0,$this->time_out);if (!($this->sock && $this->smtp_ok())) { $this->log_write("Error:Cannot connenct to relay host ".$this->relay_host."\n");$this->log_write("Error:".$_F0." (".$_EF.")\n");return FALSE;} $this->log_write("Connected to relay host ".$this->relay_host."\n");return TRUE;;} function smtp_sockopen_mx($_EE){ $_F1=ereg_replace("^.+@([^@]+)$","\1",$_EE);if (!@getmxrr($_F1,$_F2)) { $this->log_write("Error:Cannot resolve MX \"".$_F1."\"\n");return FALSE;} foreach ($_F2 as $_F3) { $this->log_write("Trying to ".$_F3.":".$this->smtp_port."\n");$this->sock=@fsockopen($_F3,$this->smtp_port,$_EF,$_F0,$this->time_out);if (!($this->sock && $this->smtp_ok())) { $this->log_write("Warning:Cannot connect to mx host ".$_F3."\n");$this->log_write("Error:".$_F0." (".$_EF.")\n");continue;} $this->log_write("Connected to mx host ".$_F3."\n");return TRUE;} $this->log_write("Error:Cannot connect to any mx hosts (".implode(",",$_F2).")\n");return FALSE;} function smtp_message($_E7,$_E1){ fputs($this->sock,$_E7."\r\n".$_E1);$this->smtp_debug("> ".str_replace("\r\n","\n"."> ",$_E7."\n> ".$_E1."\n> "));return TRUE;} function smtp_eom(){ fputs($this->sock,"\r\n.\r\n");$this->smtp_debug(".[EOM]\n");return $this->smtp_ok();} function smtp_ok(){ $_F4=str_replace("\r\n","",fgets($this->sock,512));$this->smtp_debug($_F4."\n");if (!ereg("^[23]",$_F4)) { fputs($this->sock,"QUIT\r\n");fgets($this->sock,512);$this->log_write("Error:Remote host returned \"".$_F4."\"\n");return FALSE;} return TRUE;} function smtp_putcmd($_F5,$_F6=""){ if ($_F6 !="") { if($_F5=="") $_F5=$_F6;else $_F5=$_F5." ".$_F6;} fputs($this->sock,$_F5."\r\n");$this->smtp_debug("> ".$_F5."\n");return $this->smtp_ok();} function smtp_error($_30){ $this->log_write("Error:Error occurred while ".$_30.".\n");return FALSE;} function log_write($_F7){ $this->smtp_debug($_F7);if ($this->log_file=="") { return TRUE;} $_F7=date("M d H:i:s ").get_current_user()."[".getmypid()."]:".$_F7;if (!@file_exists($this->log_file) || !($_F8=@fopen($this->log_file,"a"))) { $this->smtp_debug("Warning:Cannot open log file \"".$this->log_file."\"\n");return FALSE;;} flock($_F8,LOCK_EX);fputs($_F8,$_F7);fclose($_F8);return TRUE;} function strip_comment($_EE){ $_F9="\([^()]*\)";while (ereg($_F9,$_EE)) { $_EE=ereg_replace($_F9,"",$_EE);} return $_EE;} function get_address($_EE){ $_EE=ereg_replace("([ \t\r\n])+","",$_EE);$_EE=ereg_replace("^.*<(.+)>.*$","\1",$_EE);return $_EE;} function smtp_debug($_F7){ if ($this->debug) { echo $_F7;} } } ?>
